<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sharewise App</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <div class="container mt-5">
    <h1 class="text-center">Sharewise App</h1>
    <div class="row">
      <div class="col-md-4">
        <h3>Add User</h3>
        <form id="addUserForm">
          <div class="mb-3">
            <input type="text" id="userName" class="form-control" placeholder="Enter user name" required />
          </div>
          <button type="submit" class="btn btn-primary w-100">Add User</button>
        </form>
        <h3 class="mt-4">Users</h3>
        <ul id="userList" class="list-group"></ul>
      </div>

      <div class="col-md-8">
        <h3>Add Expense</h3>
        <form id="addExpenseForm">
          <div class="mb-3">
            <input type="text" id="expenseDescription" class="form-control" placeholder="Expense description" required />
          </div>
          <div class="mb-3">
            <input type="number" id="expenseAmount" class="form-control" placeholder="Amount" required />
          </div>
          <div class="mb-3">
            <select id="expensePaidBy" class="form-select" required>
              <option value="" disabled selected>Paid by</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="expenseSplitAmong" class="form-label">Split among (hold Ctrl/Cmd to select multiple)</label>
            <select id="expenseSplitAmong" class="form-control" multiple required size="5">
              <option value="" disabled>-- Select users to split --</option>
            </select>
          </div>
          <button type="submit" class="btn btn-success w-100">Add Expense</button>
        </form>
        <h3 class="mt-4">Expenses</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Description</th>
              <th>Amount</th>
              <th>Paid By</th>
              <th>Split Among</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="expenseList"></tbody>
        </table>
        <h3 class="mt-4">Balances</h3>
        <ul id="balances" class="list-group"></ul>
        <h3 class="mt-4">Who Owes Whom</h3>
        <ul id="userOwesList" class="list-group"></ul>
        
        <h3 class="mt-4">Share & Import</h3>
        <div class="btn-group-vertical w-100" role="group">
          <button id="shareButton" class="btn btn-primary mb-2">
            <i class="fas fa-share-alt"></i> Share via Link
          </button>
          <button id="copyCodeButton" class="btn btn-info mb-2">
            <i class="fas fa-copy"></i> Copy Share Code
          </button>
          <button id="importCodeButton" class="btn btn-warning mb-2">
            <i class="fas fa-download"></i> Import Share Code
          </button>
          <button id="exportButton" class="btn btn-success mb-2">
            <i class="fas fa-file-export"></i> Export to File
          </button>
          <button id="importButton" class="btn btn-secondary mb-2">
            <i class="fas fa-file-import"></i> Import from File
          </button>
          <input type="file" id="fileInput" accept=".json" style="display: none;" />
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center mt-5">
    <p class="text-muted">This app is independently developed and is not affiliated with or endorsed by any expense tracking company. All rights reserved by the respective owners.</p>
  </footer>

  <script>
    $(document).ready(() => {
      // Load data from localStorage if available
      const users = JSON.parse(localStorage.getItem('sharewise_users') || '[]');
      const expenses = JSON.parse(localStorage.getItem('sharewise_expenses') || '[]');

      // Save data to localStorage
      const saveToLocalStorage = () => {
        localStorage.setItem('sharewise_users', JSON.stringify(users));
        localStorage.setItem('sharewise_expenses', JSON.stringify(expenses));
      };

      const updateUI = () => {
        $("#userList").empty();
        $("#expenseList").empty();
        $("#balances").empty();
        $("#userOwesList").empty();

        users.forEach((user, index) => {
          $("#userList").append(`
            <li class='list-group-item d-flex justify-content-between align-items-center'>
              ${user}
              <span>
                <button class='btn btn-sm btn-primary edit-user' data-index='${index}'>
                  <i class='fas fa-edit'></i>
                </button>
                <button class='btn btn-sm btn-danger delete-user' data-index='${index}'>
                  <i class='fas fa-trash'></i>
                </button>
              </span>
            </li>
          `);
        });

        expenses.forEach((expense, index) => {
          $("#expenseList").append(`
            <tr data-index='${index}'>
              <td>${expense.description}</td>
              <td>₹${expense.amount.toFixed(2)}</td>
              <td>${expense.paidBy}</td>
              <td>${expense.splitAmong.join(', ')}</td>
              <td>
                <button class='btn btn-sm btn-primary edit-expense'>
                  <i class='fas fa-edit'></i>
                </button>
                <button class='btn btn-sm btn-danger delete-expense'>
                  <i class='fas fa-trash'></i>
                </button>
              </td>
            </tr>
          `);
        });

        const balances = {};
        users.forEach(user => {
          balances[user] = 0;
        });

        expenses.forEach(expense => {
          const splitAmount = expense.amount / expense.splitAmong.length;
          expense.splitAmong.forEach(person => {
            if (person !== expense.paidBy) {
              balances[expense.paidBy] += splitAmount;
              balances[person] -= splitAmount;
            }
          });
        });

        Object.entries(balances).forEach(([user, balance]) => {
          const balanceClass = balance > 0 ? 'text-success' : balance < 0 ? 'text-danger' : 'text-muted';
          const balanceText = balance > 0 ? `gets back ₹${balance.toFixed(2)}` : balance < 0 ? `owes ₹${Math.abs(balance).toFixed(2)}` : 'settled up';
          $("#balances").append(`<li class='list-group-item d-flex justify-content-between'><span>${user}</span><span class='${balanceClass} font-weight-bold'>${balanceText}</span></li>`);
        });

        const owes = {};
        Object.entries(balances).forEach(([user1, balance1]) => {
          if (balance1 < 0) {
            Object.entries(balances).forEach(([user2, balance2]) => {
              if (balance2 > 0) {
                const owedAmount = Math.min(-balance1, balance2);
                if (owedAmount > 0) {
                  const key = `${user1}->${user2}`;
                  owes[key] = (owes[key] || 0) + owedAmount;
                  balances[user1] += owedAmount;
                  balances[user2] -= owedAmount;
                }
              }
            });
          }
        });

        Object.entries(owes).forEach(([key, amount]) => {
          const [from, to] = key.split('->');
          $("#userOwesList").append(`<li class='list-group-item'><strong>${from}</strong> owes <strong>${to}</strong>: <span class='text-success'>₹${amount.toFixed(2)}</span></li>`);
        });

        populateDropdowns();
      };

      // === SHARING FUNCTIONS ===
      
      // Encode data to Base64
      const encodeData = () => {
        const data = { users, expenses };
        return btoa(encodeURIComponent(JSON.stringify(data)));
      };
      
      // Decode data from Base64
      const decodeData = (encoded) => {
        try {
          return JSON.parse(decodeURIComponent(atob(encoded)));
        } catch (e) {
          console.error('Failed to decode data:', e);
          return null;
        }
      };
      
      // Generate shareable link with URL hash
      const generateShareLink = () => {
        if (users.length === 0 || expenses.length === 0) {
          alert('Please add at least one user and one expense before sharing.');
          return;
        }
        
        const encoded = encodeData();
        const baseUrl = window.location.origin + window.location.pathname;
        const shareUrl = `${baseUrl}#${encoded}`;
        
        // Check URL length
        if (shareUrl.length > 2000) {
          alert('Too much data for URL sharing! Please use "Export to File" instead.');
          return;
        }
        
        navigator.clipboard.writeText(shareUrl).then(() => {
          alert('✅ Share link copied to clipboard!\n\nPaste and send this link to anyone.\nThey can click it to view your calculations.');
        }).catch(() => {
          prompt('Copy this link to share:', shareUrl);
        });
      };
      
      // Copy share code
      const copyShareCode = () => {
        if (users.length === 0 || expenses.length === 0) {
          alert('Please add at least one user and one expense before sharing.');
          return;
        }
        
        const encoded = encodeData();
        navigator.clipboard.writeText(encoded).then(() => {
          alert('✅ Share code copied to clipboard!\n\nSend this code to anyone.\nThey can use "Import Share Code" to load it.');
        }).catch(() => {
          prompt('Copy this share code:', encoded);
        });
      };
      
      // Import share code
      const importShareCode = () => {
        const code = prompt('Paste the share code you received:');
        if (!code) return;
        
        const data = decodeData(code);
        if (!data || !data.users || !data.expenses) {
          alert('❌ Invalid share code. Please check and try again.');
          return;
        }
        
        if (confirm(`This will replace your current data with:\n\n${data.users.length} users\n${data.expenses.length} expenses\n\nContinue?`)) {
          users.length = 0;
          expenses.length = 0;
          users.push(...data.users);
          expenses.push(...data.expenses);
          saveToLocalStorage();
          updateUI();
          alert('✅ Data imported successfully!');
        }
      };
      
      // Export to JSON file
      const exportToFile = () => {
        if (users.length === 0 || expenses.length === 0) {
          alert('Please add at least one user and one expense before exporting.');
          return;
        }
        
        const data = { users, expenses };
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sharewise-expenses-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        alert('✅ File downloaded! Share this file with others.');
      };
      
      // Import from JSON file
      const importFromFile = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (!data.users || !data.expenses) {
              alert('❌ Invalid file format.');
              return;
            }
            
            if (confirm(`This will replace your current data with:\n\n${data.users.length} users\n${data.expenses.length} expenses\n\nContinue?`)) {
              users.length = 0;
              expenses.length = 0;
              users.push(...data.users);
              expenses.push(...data.expenses);
              saveToLocalStorage();
              updateUI();
              alert('✅ Data imported successfully!');
            }
          } catch (err) {
            alert('❌ Error reading file: ' + err.message);
          }
          // Reset file input
          event.target.value = '';
        };
        reader.readAsText(file);
      };
      
      // Load shared data from URL hash
      const loadSharedData = () => {
        const hash = window.location.hash.substring(1);
        if (hash && hash.length > 10) {
          const data = decodeData(hash);
          if (data && data.users && data.expenses) {
            if (confirm(`Load shared data?\n\n${data.users.length} users\n${data.expenses.length} expenses\n\nThis will replace your current data.`)) {
              users.length = 0;
              expenses.length = 0;
              users.push(...data.users);
              expenses.push(...data.expenses);
              saveToLocalStorage();
              updateUI();
              // Clear hash after loading
              history.replaceState(null, null, ' ');
              alert('✅ Shared data loaded successfully!');
            } else {
              // Clear hash if user cancels
              history.replaceState(null, null, ' ');
            }
          }
        }
      };

      $("#addUserForm").submit(e => {
        e.preventDefault();
        const userName = $("#userName").val().trim();
        if (!userName) {
          alert('Please enter a user name.');
          return;
        }
        if (users.includes(userName)) {
          alert('User already exists!');
          return;
        }
        users.push(userName);
        $("#userName").val("");
        saveToLocalStorage();
        updateUI();
      });

      $(document).on("click", ".edit-user", function () {
        const index = $(this).data("index");
        const userName = users[index];
        const newUserName = prompt("Edit user name:", userName);
        if (newUserName && newUserName.trim() && newUserName !== userName) {
          if (users.includes(newUserName)) {
            alert('A user with this name already exists!');
            return;
          }
          users[index] = newUserName.trim();
          expenses.forEach(expense => {
            if (expense.paidBy === userName) expense.paidBy = newUserName.trim();
            expense.splitAmong = expense.splitAmong.map(person => person === userName ? newUserName.trim() : person);
          });
          saveToLocalStorage();
          updateUI();
        }
      });

      $(document).on("click", ".delete-user", function () {
        const index = $(this).data("index");
        const userName = users[index];
        const userExpenses = expenses.filter(e => e.paidBy === userName || e.splitAmong.includes(userName));
        if (userExpenses.length > 0) {
          if (!confirm(`${userName} is part of ${userExpenses.length} expense(s). Deleting will remove them from all expenses. Continue?`)) {
            return;
          }
        }
        if (confirm(`Are you sure you want to delete user: ${userName}?`)) {
          users.splice(index, 1);
          // Remove user from expenses
          expenses.forEach((expense, i) => {
            expense.splitAmong = expense.splitAmong.filter(person => person !== userName);
            // If no one left to split among, or payer was deleted, remove expense
            if (expense.splitAmong.length === 0 || expense.paidBy === userName) {
              expenses.splice(i, 1);
            }
          });
          saveToLocalStorage();
          updateUI();
        }
      });

      $("#addExpenseForm").submit(e => {
        e.preventDefault();
        const description = $("#expenseDescription").val().trim();
        const amount = parseFloat($("#expenseAmount").val().trim());
        const paidBy = $("#expensePaidBy").val();
        const splitAmong = $("#expenseSplitAmong").val();

        if (!description) {
          alert('Please enter an expense description.');
          return;
        }
        if (!amount || amount <= 0) {
          alert('Please enter a valid amount greater than 0.');
          return;
        }
        if (!paidBy) {
          alert('Please select who paid for this expense.');
          return;
        }
        if (!splitAmong || splitAmong.length === 0) {
          alert('Please select at least one person to split the expense among.');
          return;
        }

        expenses.push({
          description,
          amount,
          paidBy,
          splitAmong
        });
        
        // Reset form completely
        $("#expenseDescription").val("");
        $("#expenseAmount").val("");
        $("#expensePaidBy").val("");
        $("#expenseSplitAmong").val([]);
        
        saveToLocalStorage();
        updateUI();
      });

      const populateDropdowns = () => {
        const paidByValue = $("#expensePaidBy").val();
        const splitAmongValue = $("#expenseSplitAmong").val() || [];
        
        $("#expensePaidBy").empty().append('<option value="" disabled selected>Paid by</option>');
        $("#expenseSplitAmong").empty();
        
        users.forEach(user => {
          $("#expensePaidBy").append(`<option value='${user}'>${user}</option>`);
          $("#expenseSplitAmong").append(`<option value='${user}'>${user}</option>`);
        });
        
        // Restore selections if still valid
        if (users.includes(paidByValue)) $("#expensePaidBy").val(paidByValue);
        const validSplits = splitAmongValue.filter(u => users.includes(u));
        if (validSplits.length > 0) $("#expenseSplitAmong").val(validSplits);
      };

      $(document).on("click", ".edit-expense", function () {
        const index = $(this).closest("tr").data("index");
        const expense = expenses[index];

        $("#expenseDescription").val(expense.description);
        $("#expenseAmount").val(expense.amount);
        $("#expensePaidBy").val(expense.paidBy);
        $("#expenseSplitAmong").val(expense.splitAmong);

        expenses.splice(index, 1);
        saveToLocalStorage();
        updateUI();
        
        // Scroll to form
        $('html, body').animate({scrollTop: $('#addExpenseForm').offset().top - 100}, 500);
      });

      $(document).on("click", ".delete-expense", function () {
        const index = $(this).closest("tr").data("index");
        if (confirm('Are you sure you want to delete this expense?')) {
          expenses.splice(index, 1);
          saveToLocalStorage();
          updateUI();
        }
      });

      // Share button handlers
      $("#shareButton").click(generateShareLink);
      $("#copyCodeButton").click(copyShareCode);
      $("#importCodeButton").click(importShareCode);
      $("#exportButton").click(exportToFile);
      $("#importButton").click(() => $("#fileInput").click());
      $("#fileInput").change(importFromFile);

      // Load shared data on page load
      loadSharedData();
      updateUI();
    });
  </script>
</body>
</html>